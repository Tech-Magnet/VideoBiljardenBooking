<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../img/icon.png">
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FPJBGKX7R0"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-FPJBGKX7R0');
    </script>
    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
          apiKey: "AIzaSyAxv9AQ5b9Ig9HnCAzxfLcHfdojZiGMyNQ",
          authDomain: "videobiljardenorebrosite.firebaseapp.com",
          databaseURL: "https://videobiljardenorebrosite-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "videobiljardenorebrosite",
          storageBucket: "videobiljardenorebrosite.appspot.com",
          messagingSenderId: "1042889427467",
          appId: "1:1042889427467:web:bbbedfe2ce5eea96d8d50e",
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
      </script>
</head>
<body>
    <div id="div2" class="container-canvas">
      <h2 class="title-locked">Logga in p&aring admin portalen</h2>
      <br>
      <br>
      <label for="username" class="login-label" id="usernameLabel">Andv&aumlrnamn</label><br>
      <input type="text" class="login-fields" id="txtName"><br><br>
      <label for="password" class="login-label" id="PasswordLabel">L&oumlsenord</label><br>
      <input type="password" class="login-fields" id="txtPassword"><br><br>
      <button id="btnLogin" class="login-fields2" onclick="login();">Logga In</button>
      <br>
      <br>
        <p id="error"></p>
        <script>
        var database = firebase.database();
        var tableBody = document.querySelector("#bookingTable tbody");

        var username_t = localStorage.getItem('token_u');
        var password_t = localStorage.getItem('token_p');

        if (username_t != null && password_t != null){
          database.ref("login").on("child_added", function (snapshot) {
          var login = snapshot.val();

          if (username_t == login.username && password_t == login.password){
            document.getElementById("div").style.display = "block";
            document.getElementById("div2").style.display = "none";
          }
          });
        }
        function login(){
            var username = document.getElementById('txtName').value;
            var password = document.getElementById('txtPassword').value;

            database.ref("login").on("child_added", function (snapshot) {
            var login = snapshot.val();

            if (username == login.username && password == login.password){
              document.getElementById("div").style.display = "block";
              document.getElementById("div2").style.display = "none";
              localStorage.setItem('token_u', username);
              localStorage.setItem('token_p', password);
            }else{
              document.getElementById('error').innerTEXT = "Wrong Password or Username";
            }
            });
        }
        </script>
  </div>
  <div id="div" style="display: none;">


    
    <h3 style="color: #000000;">Aktiva Bokningar</h3>
    <table id="bookingTable" style="width:80vw;" border="1">
      <thead>
        <tr>
            <th>Namn</th>
            <th>Telnr</th>
            <th>Dag</th>
            <th>Tid</th>
            <th>Slut</th>
            <th>L&aumlngd</th>
            <th>Bord</th>
            <th>Vecka</th>
            <th>Medlem</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th>M&AringNDAG</th>
        </tr>
      </tbody>
      <tbody class="tb_1">
      </tbody>
      <tbody class="tb_1_2">
      </tbody>
      <tbody>
        <tr>
          <th>TISDAG</th>
        </tr>
      </tbody>
      <tbody class="tb_2">
      </tbody>
      <tbody class="tb_2_2">
      </tbody>
      <tbody>
        <tr>
          <th>ONSDAG</th>
        </tr>
      </tbody>
      <tbody class="tb_3">
      </tbody>
      <tbody class="tb_3_2">
      </tbody>
      <tbody>
        <tr>
          <th>TORSDAG</th>
        </tr>
      </tbody>
      <tbody class="tb_4">
      </tbody>
      <tbody class="tb_4_2">
      </tbody>
      <tbody>
        <tr>
          <th>FREDAG</th>
        </tr>
      </tbody>
      <tbody class="tb_5">
      </tbody>
      <tbody class="tb_5_2">
      </tbody>
      <tbody>
        <tr>
          <th>L&OumlRDAG</th>
        </tr>
      </tbody>
      <tbody class="tb_6">
      </tbody>
      <tbody class="tb_6_2">
      </tbody>
      <tbody>
        <tr>
          <th>S&OumlNDAG</th>
        </tr>
      </tbody>
      <tbody class="tb_7">
      </tbody>
      <tbody class="tb_7_2">
      </tbody>
    </table>

      <h3 style="color: #000000;">Aktiva Medlemskap</h3>
      <table id="paymentTable" style="width: 40vw;" border="1">
        <thead>
          <th>Namn</th>
          <th>TelNr</th>
          <th>Senaste Betalning</th>
          <th>N&aumlsta Betalning</th>
          <th>Ta Bort</th>
        </thead>
        <tbody class="pay_tb_1">
        </tbody>
      </table>

      <div style="display: flex;">
        <label for="name" class="login-label">Namn</label>
        <input type="text" class="login-fields" id="txtName_m" style="margin-top: 10px;">
        </div>

        <div style="display: flex;">
        <label for="phone" class="login-label">Tel.Nr</label>
        <input type="text" class="login-fields" id="txtPhone">
        </div>

        <div style="display: flex;">
        <label for="last" class="login-label" id="lastLabel">Betald</label>
        <input type="date" class="login-fields" id="txtLast">
        </div>
        

        <div style="display: flex;">
          <label for="next" class="login-label" id="nextLabel">L&aumlngd</label>
          <select class="login-fields" id="txtNext">
            <!--Week One (Current)-->
            <option value="1">1 M&aringnad</option>
            <option value="2">2 M&aringnader</option>
            <option value="3">3 M&aringnader</option>
            <option value="4">4 M&aringnader</option>
            <option value="5">5 M&aringnader</option>
            <option value="6">6 M&aringnader</option>
            <option value="7">7 M&aringnader</option>
            <option value="8">8 M&aringnader</option>
            <option value="9">9 M&aringnader</option>
            <option value="10">10 M&aringnader</option>
            <option value="11">11 M&aringnader</option>
            <option value="12">12 M&aringnader</option>
          </select>
          </div>

        <button id="btnCreate" class="login-fields2" onclick="AddData();">Registera Medlemskap</button>
        <script>
          function AddData(){
            console.log("ADDING DATA");
              var name_member = document.getElementById('txtName_m').value;
              var phone_m = document.getElementById('txtPhone').value;
              var last = document.getElementById('txtLast').value;
              var next = document.getElementById('txtNext').value;
              next = parseInt(next);
              console.log(next);

              if (name_member == "" || phone_m == ""){
                alert("Namn och Tel nr måste vara ifyllda");
                return;
              }
              if(phone_m.length != 10 || name_member < 2){
                alert("Ogilight Telefon Nummer eller Namn");
              }

              // Get the current date
              var currentDate;
              console.log(currentDate);

              if(last == ""){
                currentDate = new Date();
                console.log(currentDate);
              }else{
                currentDate = new Date(last);
                console.log(currentDate);
              }

              // Calculate the next month's date
              const nextMonth = new Date(currentDate);
              nextMonth.setMonth(currentDate.getMonth() + next);

              // Handle cases where the day of the next month might not exist (e.g., Jan 31st to Feb 28th/29th)
              if (currentDate.getDate() > nextMonth.getDate()) {
                  nextMonth.setDate(0); // This will set the date to the last day of the previous month
              }

              var next_m = currentDate.toISOString().split('T')[0];
              var last_m = nextMonth.toISOString().split('T')[0];

              //var next = current_date;
              console.log(name_member);
              console.log(phone_m);
              console.log("LAST: " + last);


              
              var database = firebase.database();
                database.ref("members").push().set({
                name: name_member,
                phone: phone_m,
                next: next_m,
                last: last_m
              });
              console.log("DATA INSETED");
          }
        </script>
    <script>

      function remove_member(phoneToDelete){

        var Ref = database.ref("members");
        var query = Ref.orderByChild("phone").equalTo(phoneToDelete);

        query.once("value")
          .then(function(snapshot) {
            snapshot.forEach(function(childSnapshot) {
              var node = childSnapshot.val();
                // Delete the node
                Ref.child(childSnapshot.key).remove()
                  .then(function() {
                    console.log("Member deleted: ", node);
                    window.location.reload();
                  })
                  .catch(function(error) {
                    console.error("Error deleting node: ", error);
                  });
            });
          })
          .catch(function(error) {
            console.error("Error searching for nodes:", error);
          });
      }

        var database = firebase.database();

        var tableBody1 = document.querySelector(".tb_1");//MONDAY
        var tableBody2 = document.querySelector(".tb_2");//TUESDAY
        var tableBody3 = document.querySelector(".tb_3");//WEDNESDAY
        var tableBody4 = document.querySelector(".tb_4");//THURSDAY
        var tableBody5 = document.querySelector(".tb_5");//FRIDAY
        var tableBody6 = document.querySelector(".tb_6");//SATURDAY
        var tableBody7 = document.querySelector(".tb_7");//SUNDAY

        var tableBody1_2 = document.querySelector(".tb_1_2");//MONDAY
        var tableBody2_2 = document.querySelector(".tb_2_2");//TUESDAY
        var tableBody3_2 = document.querySelector(".tb_3_2");//WEDNESDAY
        var tableBody4_2 = document.querySelector(".tb_4_2");//THURSDAY
        var tableBody5_2 = document.querySelector(".tb_5_2");//FRIDAY
        var tableBody6_2 = document.querySelector(".tb_6_2");//SATURDAY
        var tableBody7_2 = document.querySelector(".tb_7_2");//SUNDAY

        const membersArr = [];
        var memberStatus = false;


        /*MEMBERS TABLE*/
        database.ref("members").on("child_added", function (snapshot) {
            var members = snapshot.val();
            var tablebody_m = document.querySelector(".pay_tb_1");//Table Members
            var newRow = document.createElement("tr");
            
            //CREATES THE ELEMTS IN THE TABLE
            var m_nameCell = document.createElement("td");
            var m_phoneCell = document.createElement("td");
            var m_nextCell = document.createElement("td");
            var m_lastCell = document.createElement("td");
            var m_removeCell = document.createElement("td");

            var m_removeLink = document.createElement("a");
              m_removeLink.style.color = "#ff0000";
              m_removeLink.style.textDecoration = "underline";
              m_removeLink.className = "removeMember";
              m_removeLink.textContent = "Ta Bort";

            var expDate = new Date(members.last);

            if(expDate >= new Date()){

              m_nameCell.textContent = members.name;
              m_phoneCell.textContent = members.phone;
              m_nextCell.textContent = members.next;
              m_lastCell.textContent = members.last;
              m_removeLink.onclick = function(){remove_member(members.phone)};

              membersArr.push(members.phone);

              //PREPARING FOR ADDING TO NEW ROW OF TABLE
              newRow.appendChild(m_nameCell);
              newRow.appendChild(m_phoneCell);
              newRow.appendChild(m_nextCell);
              newRow.appendChild(m_lastCell);
              newRow.appendChild(m_removeCell);
              m_removeCell.appendChild(m_removeLink);

              //ADDS IT TO THE TABLE
              tablebody_m.appendChild(newRow);

            }else{
              //DELETES EXPIRED NODES

              //CALCUTE PREVIUS MONTH
              // Create a new Date object
              var currentDate = new Date();

              // Get the year and month
              var year = currentDate.getFullYear();
              var month = currentDate.getMonth();

              // Format the date as "YYYY-MM"
              var formattedDate = year + "-" + (month < 10 ? "0" : "") + month;

              if(formattedDate == year + "-00"){
                year = year - 1;
                formattedDate = year + "-12";
              }


              //DELETING NODES
              var database = firebase.database();
              const nodeRef = database.ref('members');

              const substringToMatch = formattedDate;

              // Create a query to find child nodes where the attribute contains the substring
              const query = nodeRef.orderByChild('last').startAt(substringToMatch).endAt(substringToMatch + '\uf8ff');

              query.once('value')
                .then((snapshot) => {
                  snapshot.forEach((childSnapshot) => {
                    // Delete the child node
                    childSnapshot.ref.remove()
                      .then(() => {
                        console.log('Child node deleted:', childSnapshot.key);
                      })
                      .catch((error) => {
                        console.error('Error deleting child node:', error);
                      });
                  });
                })
                .catch((error) => {
                  console.error('Error querying data:', error);
                });
            }
        });

            

        database.ref("admin").on("child_added", function (snapshot) {
          var book = snapshot.val();
        
          var newRow = document.createElement("tr");
        
          var nameCell = document.createElement("td");
          var phoneCell = document.createElement("td");
          var dayCell = document.createElement("td");
          var timeCell = document.createElement("td");
          var endTimeCell = document.createElement("td");
          var lengthCell = document.createElement("td");
          var tableCell = document.createElement("td");
          var WeekCell = document.createElement("td");
          var memberCell = document.createElement("td");
          
          
          nameCell.textContent = book.name;
          phoneCell.textContent = book.phone;
          dayCell.textContent = book.day;
          timeCell.textContent = book.time;
          lengthCell.textContent = book.length;
          var name = book.name;
          var endTime = book.endtime;
          var tableVar = book.table;

          if (endTime == '25'){
            endTimeCell.textContent = '1';
          }else{
            endTimeCell.textContent = book.endtime;
          }

          if (tableVar.endsWith('_c')){
            tableVar = tableVar.replace("_c", "");
            tableCell.textContent = tableVar;
            WeekCell.textContent = 'Nästa';
          }
          else{
            tableCell.textContent = tableVar;
            WeekCell.textContent = 'Denna';
          }

          if (membersArr.includes(book.phone)){
            memberCell.textContent = "JA";
          }
          else{
            memberCell.textContent = "NEJ";
          }
        
          newRow.appendChild(nameCell);
          newRow.appendChild(phoneCell);
          newRow.appendChild(dayCell);
          newRow.appendChild(timeCell);
          newRow.appendChild(endTimeCell);
          newRow.appendChild(lengthCell);
          newRow.appendChild(tableCell);
          newRow.appendChild(WeekCell);
          newRow.appendChild(memberCell);

          if(book.day == 'mon'){
            if(WeekCell.textContent == 'Denna'){
              tableBody1.appendChild(newRow);
            }else {
              tableBody1_2.appendChild(newRow);
            }
          }else if(book.day == 'tis') {
            if(WeekCell.textContent == 'Denna'){
              tableBody2.appendChild(newRow);
            }else {
              tableBody2_2.appendChild(newRow);
            }
          }else if(book.day == 'ons') {
            if(WeekCell.textContent == 'Denna'){
              tableBody3.appendChild(newRow);
            }else {
              tableBody3_2.appendChild(newRow);
            }
          }else if(book.day == 'tor') {
            if(WeekCell.textContent == 'Denna'){
              tableBody4.appendChild(newRow);
            }else {
              tableBody4_2.appendChild(newRow);
            }
          }else if(book.day == 'fre') {
            if(WeekCell.textContent == 'Denna'){
              tableBody5.appendChild(newRow);
            }else {
              tableBody5_2.appendChild(newRow);
            }
          }else if(book.day == 'lor') {
            if(WeekCell.textContent == 'Denna'){
              tableBody6.appendChild(newRow);
            }else {
              tableBody6_2.appendChild(newRow);
            }
          }else if(book.day == 'son') {
            if(WeekCell.textContent == 'Denna'){
              tableBody7.appendChild(newRow);
            }else {
              tableBody7_2.appendChild(newRow);
            }
          }
        });
    </script>
  </div>
</body>
</html>