<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel</title>
    <link rel="icon" href="../img/icon.png">
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FPJBGKX7R0"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-FPJBGKX7R0');
    </script>
    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
          apiKey: "AIzaSyAxv9AQ5b9Ig9HnCAzxfLcHfdojZiGMyNQ",
          authDomain: "videobiljardenorebrosite.firebaseapp.com",
          databaseURL: "https://videobiljardenorebrosite-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "videobiljardenorebrosite",
          storageBucket: "videobiljardenorebrosite.appspot.com",
          messagingSenderId: "1042889427467",
          appId: "1:1042889427467:web:bbbedfe2ce5eea96d8d50e",
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
      </script>
</head>
<body>
    <div id="div2" class="container-canvas">
      <h2 class="title-locked">Logga in p&aring admin portalen</h2>
      <br>
      <br>
      <label for="username" class="login-label" id="usernameLabel">Andv&aumlrnamn</label><br>
      <input type="text" class="login-fields" id="txtName"><br><br>
      <label for="password" class="login-label" id="PasswordLabel">L&oumlsenord</label><br>
      <input type="password" class="login-fields" id="txtPassword"><br><br>
      <button id="btnLogin" class="login-fields2" onclick="login();">Logga In</button>
      <br>
      <br>
        <p id="error"></p>
        <script>
        var database = firebase.database();
        var tableBody = document.querySelector("#bookingTable tbody");

        var username_t = localStorage.getItem('token_u');
        var password_t = localStorage.getItem('token_p');

        if (username_t != null && password_t != null){
          database.ref("login").on("child_added", function (snapshot) {
          var login = snapshot.val();

          if (username_t == login.username && password_t == login.password){
            document.getElementById("div").style.display = "block";
            document.getElementById("div2").style.display = "none";
          }
          });
        }
            function login(){
                var username = document.getElementById('txtName').value;
                var password = document.getElementById('txtPassword').value;

                database.ref("login").on("child_added", function (snapshot) {
                var login = snapshot.val();

                if (username == login.username && password == login.password){
                  document.getElementById("div").style.display = "block";
                  document.getElementById("div2").style.display = "none";
                  localStorage.setItem('token_u', username);
                  localStorage.setItem('token_p', password);
                }else{
                  document.getElementById('error').innerTEXT = "Wrong Password or Username";
                }
                });
                
            }
        </script>
    </div>
    <div id="div" style="display: none;">
    <h3 style="color: #000000;">Aktiva Bokningar</h3>
    <table id="bookingTable" style="width:80vw" border="1">
      <thead>
        <tr>
            <th> </tr>
            <th>Namn</th>
            <th>Telnr</th>
            <th>Dag</th>
            <th>Tid</th>
            <th>Slut</th>
            <th>L&aumlngd</th>
            <th>Bord</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <p>Bord_c = N&aumlsta vecka</p>
    <script>
        var database = firebase.database();
        var tableBody = document.querySelector("#bookingTable tbody");

        database.ref("admin").on("child_added", function (snapshot) {
          var book = snapshot.val();
        
          var newRow = document.createElement("tr");
        
          var nameCell = document.createElement("td");
          var phoneCell = document.createElement("td");
          var dayCell = document.createElement("td");
          var timeCell = document.createElement("td");
          var endTimeCell = document.createElement("td");
          var lengthCell = document.createElement("td");
          var tableCell = document.createElement("td");
        
          nameCell.textContent = book.name;
          phoneCell.textContent = book.phone;
          dayCell.textContent = book.day;
          timeCell.textContent = book.time;
          lengthCell.textContent = book.length;
          endTimeCell.textContent = book.endtime;

          tableCell.textContent = book.table;
        
          newRow.appendChild(nameCell);
          newRow.appendChild(phoneCell);
          newRow.appendChild(dayCell);
          newRow.appendChild(timeCell);
          newRow.appendChild(endTimeCell);
          newRow.appendChild(lengthCell);
          newRow.appendChild(tableCell);
        
          tableBody.appendChild(newRow);
        });
    </script>
    <div id="PopUp_Warning" class="popup" style="display: none;">
      <center>
      <h3>&Aumlr du s&aumlker?</h3>
      <p>Detta kan p&aumlverka hela bokningsschemat</p>
      </center>
      <br>
      <!--<div class="popup-btns">
        <button id="cancel" onclick="document.getElementById('PopUp_Warning').style.display  = 'none';">Avbryt</button>
        <button id="clear-DATA"onclick="clearDB();">RENSA DATA ðŸ’€</button>
      </div>
    </div>
      <br>
      <br>
      <input type="button" name="button" id="smt-button" value="RENSA DATA ðŸ’€"  class="btn btn-primary btn-lg btn-block" style="background-color: red;" onclick="document.getElementById('PopUp_Warning').style.display  = 'block'">
        <script>
            function clearDB(){
                  document.getElementById('PopUp_Warning').style.display  = 'none'
                  var database = firebase.database();
                  var characterToEndWith = "_c"; // Character to check for at the end of "table"

                  /*BOOKING--------------------------------------------------------------------*/
                  // Create a reference to the "booking" node
                  var bookingRef = database.ref("booking");

                  // Step 1: Query for entries that end with "_c"
                  var query = bookingRef.orderByChild("table").endAt(characterToEndWith + "\uf8ff");

                  // Collect keys of entries that end with "_c"
                  var keysToSave = [];
                  query.once("value")
                    .then(function(snapshot) {
                      snapshot.forEach(function(childSnapshot) {
                        keysToSave.push(childSnapshot.key);
                      });
                    
                      // Step 2: Retrieve all entries and filter out keysToDelete
                      bookingRef.once("value")
                        .then(function(allSnapshot) {
                          allSnapshot.forEach(function(childSnapshot) {
                            var key = childSnapshot.key;
                            if (!keysToSave.includes(key)) {
                              // Delete the entry from the database
                              bookingRef.child(key).remove()
                                .then(function() {
                                  console.log("Entry successfully deleted:", key);
                                })
                                .catch(function(error) {
                                  console.error("Error deleting entry:", error);
                                });
                            }  else {
                              // Remove "_c" from the "table" attribute
                              var currentTable = childSnapshot.val().table;
                              var updatedTable = currentTable.replace("_c", "");
                            
                              // Update the "table" attribute with the modified string
                              bookingRef.child(key).update({ table: updatedTable })
                                .then(function() {
                                  console.log("Entry updated:", key);
                                })
                                .catch(function(error) {
                                  console.error("Error updating entry:", error);
                                });
                            }
                          });
                        })
                        .catch(function(error) {
                          console.error("Error retrieving all entries:", error);
                        });
                      });





                      /*ADMIN------------------------------------------------------------------------*/
                      // Create a reference to the "booking" node
                      var adminRef = database.ref("admin");
                                      
                      // Step 1: Query for entries that end with "_c"
                      var query = adminRef.orderByChild("table").endAt(characterToEndWith + "\uf8ff");
                                      
                      // Collect keys of entries that end with "_c"
                      var keysToSave = [];
                      query.once("value")
                        .then(function(snapshot) {
                          snapshot.forEach(function(childSnapshot) {
                            keysToSave.push(childSnapshot.key);
                          });
                        
                          // Step 2: Retrieve all entries and filter out keysToDelete
                          adminRef.once("value")
                            .then(function(allSnapshot) {
                              allSnapshot.forEach(function(childSnapshot) {
                                var key = childSnapshot.key;
                                if (!keysToSave.includes(key)) {
                                  // Delete the entry from the database
                                  adminRef.child(key).remove()
                                    .then(function() {
                                      console.log("Entry successfully deleted:", key);
                                    })
                                    .catch(function(error) {
                                      console.error("Error deleting entry:", error);
                                    });
                                }  else {
                                  // Remove "_c" from the "table" attribute
                                  var currentTable = childSnapshot.val().table;
                                  var updatedTable = currentTable.replace("_c", "");
                                
                                  // Update the "table" attribute with the modified string
                                  adminRef.child(key).update({ table: updatedTable })
                                    .then(function() {
                                      console.log("Entry updated:", key);
                                    })
                                    .catch(function(error) {
                                      console.error("Error updating entry:", error);
                                    });
                                }
                              });
                            })
                            .catch(function(error) {
                              console.error("Error retrieving all entries:", error);
                            });
                          });
                }
        </script>-->
        </div>
</body>
</html>