<!DOCTYPE html>
<html>
<head>
    <title>Avboka Bord</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="img/icon.png">
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FPJBGKX7R0"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FPJBGKX7R0');
    </script>
    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
          apiKey: "AIzaSyAxv9AQ5b9Ig9HnCAzxfLcHfdojZiGMyNQ",
          authDomain: "videobiljardenorebrosite.firebaseapp.com",
          databaseURL: "https://videobiljardenorebrosite-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "videobiljardenorebrosite",
          storageBucket: "videobiljardenorebrosite.appspot.com",
          messagingSenderId: "1042889427467",
          appId: "1:1042889427467:web:bbbedfe2ce5eea96d8d50e",
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
      </script>
</head>
<body>
    <div class="container">
        <div class="py-5 text-center">
          <a href="https://www.orebrobiljarden.se/"><img class="d-block mx-auto mb-4" src="img/biljard.jpg" height="140px"></a>
          <h2>Avboka Bord - Snooker</h2>
        </div>
      <fieldset>
        <form id="bookingForm" name="frmBook" class="needs-validation">
          <p>
            <label for="phone">Telnr</label>
            <input type="text"  class="form-control" name="txtPhone" id="txtPhone" value="" required>
          </p>
          <p>
            <label for="Day">Datum</label>
            <select id="txtDay" name="txtDay" style="padding: 10px;">
              <!--Week One (Current)-->
              <option value="mon">M&aringndag</option>
              <option value="tis">Tisdag</option>
              <option value="ons">Onsdag</option>
              <option value="tor">Torsdag</option>
              <option value="fre">Fredag</option>
              <option value="lor">L&oumlrdag</option>
              <option value="son">S&oumlndag</option>
            </select>
          </p>
          <p>
            <label for="Week">Vecka</label>
            <select id="txtWeek" name="txtWeek" style="padding: 10px;">
              <!--Week One (Current)-->
              <option value="t">Denna Vecka</option>
              <option value="n">N&aumlsta Vecka</option>
            </select>
          </p>
          <p>
            <label for="txtTable">Bord</label>
            <select id="txtTable" name="txtTable" style="padding: 10px;">
              <option value="Bord_1">Bord 1</option>
              <option value="Bord_2">Bord 2</option>
              <option value="Bord_3">Bord 3</option>
            </select>
          </p>
          <p>&nbsp;</p>
          <p id="status_p" style="color: #00ff00;"></p>
          <p>
            <input type="button" name="button" id="smt-button" value="Avboka Bord" class="btn btn-primary btn-lg btn-block" onclick="unbook();">
          </p>
        </form>
      </fieldset>
      <input type="button" name="button" id="smt-button" value="Tillbaka"  class="btn btn-primary btn-lg btn-block" onclick="window.location.href='index.html'">
      <script>
        function unbook(){
          var found = false;
          var database = firebase.database();
          var tableToDelete = document.getElementById('txtTable').value;
          var phoneToDelete = document.getElementById('txtPhone').value;
          var dayToDelete = document.getElementById('txtDay').value;
          var weekToDelete = document.getElementById('txtWeek').value 

          if(weekToDelete == 'n'){
            tableToDelete = tableToDelete + "_c";
          }

          // Create a reference to the "booking" node
          var bookingRef = database.ref("booking");
          
          // Create a query to find the nodes with matching attributes
          var query = bookingRef.orderByChild("phone").equalTo(phoneToDelete);
          

          // Execute the query to fetch the data
          query.once("value")
            .then(function(snapshot) {
              snapshot.forEach(function(childSnapshot) {
                var node = childSnapshot.val();

                // Check if the attributes match
                if (node.table === tableToDelete && node.day === dayToDelete) {
                  // Delete the node
                  bookingRef.child(childSnapshot.key).remove()
                    .then(function() {
                      console.log("Node deleted:", node);
                      console.log("Node Deleted from booking");
                      found = true;
                    })
                    .catch(function(error) {
                      console.error("Error deleting node:", error);
                    });
                }
              });
            })
            .catch(function(error) {
              console.error("Error searching for nodes:", error);
            });

            var adminRef = database.ref("admin");

            var query = adminRef.orderByChild("phone").equalTo(phoneToDelete);

            query.once("value")
            .then(function(snapshot) {
              snapshot.forEach(function(childSnapshot) {
                var node = childSnapshot.val();

                // Check if the attributes match
                if (node.table === tableToDelete && node.day === dayToDelete) {
                  // Delete the node
                  adminRef.child(childSnapshot.key).remove()
                    .then(function() {
                      console.log("Node deleted:", node);
                      console.log("Node Deleted from Admin");
                      document.getElementById('status_p').innerText = "Tid Avbokad";
                      document.getElementById('status_p').style.color = '#00ff00';
                      found == true;
                    })
                    .catch(function(error) {
                      console.error("Error deleting node:", error);
                      document.getElementById('status_p').innerText("Ett Error Upstod, var god och försök igen");
                      document.getElementById('status_p').style.color = '#ff0000';
                    });
                }
              });
            })
            .catch(function(error) {
              console.error("Error searching for nodes:", error);
            });
            if (found == false){
              document.getElementById('status_p').innerText = "Ingen tid hittades";
              document.getElementById('status_p').style.color = '#ff0000';
            }
        }
    </script>
</body>
</html>